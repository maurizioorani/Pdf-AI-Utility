<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Knowledge Extractor - PDF Utility</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        .snippet-card {
            margin-bottom: 1rem;
            border-left: 5px solid #0d6efd;
        }
        .snippet-text {
            white-space: pre-wrap; /* Preserve line breaks and spaces */
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navbar :: page-navbar (activePage='extract')}"></div>

    <section class="hero-section text-center">
        <div class="container">
            <h1 class="display-3 fw-bold mb-4">ðŸ“š PDF Knowledge Extractor</h1>
            <p class="lead">Upload a PDF, ask a question, and let an LLM extract relevant snippets of information for you.</p>
        </div>
    </section>

    <div class="container my-5">
        <!-- Messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${infoMessage}" class="alert alert-info alert-dismissible fade show" role="alert">
            <span th:text="${infoMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Extraction Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h2>Extract Information from PDF</h2>
            </div>
            <div class="card-body">
                <form method="POST" th:action="@{/extract/process}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="pdfFile" class="form-label">Select PDF File:</label>
                        <input type="file" class="form-control" id="pdfFile" name="pdfFile" accept=".pdf" required />
                    </div>
                    <div class="mb-3">
                        <label for="query" class="form-label">Your Question/Query:</label>
                        <textarea class="form-control" id="query" name="query" rows="3" placeholder="e.g., What are the main conclusions of this document? or List all action items." th:text="${submittedQuery}" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="modelName" class="form-label">Select LLM Model for Extraction:</label>
                        <select class="form-select" id="modelName" name="modelName" required>
                            <option value="">-- Select Model --</option>
                            <option th:each="model : ${availableModels}" th:value="${model}" th:text="${model}" th:selected="${model == submittedModelName}"></option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Extract Snippets</button>
                </form>
            </div>
        </div>

        <!-- Extracted Snippets Display -->
        <div th:if="${extractedSnippets != null and not #lists.isEmpty(extractedSnippets)}" class="card mb-4">
            <div class="card-header">
                <h3><i class="fas fa-lightbulb"></i> Extracted Snippets</h3>
            </div>
            <div class="card-body">
                <form method="POST" th:action="@{/extract/save}">
                    <input type="hidden" name="originalPdfFilename" th:value="${originalPdfFilename}" />
                    <input type="hidden" name="userQuery" th:value="${userQuery}" />

                    <div th:each="snippet, iterStat : ${extractedSnippets}" class="snippet-card card">
                        <div class="card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="snippetsToSave" th:value="${snippet}" th:id="'snippetCheckbox' + ${iterStat.index}" th:aria-label="'Select snippet ' + ${iterStat.count} + ' to save'" checked>
                                <label class="form-check-label" th:for="'snippetCheckbox' + ${iterStat.index}">
                                    <strong>Snippet <span th:text="${iterStat.count}"></span></strong> (Select to save)
                                </label>
                            </div>
                            <div class="snippet-text" th:text="${snippet}"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success mt-3">Save Selected Snippets</button>
                </form>
            </div>
        </div>
        
        <!-- Saved Snippets Library -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-book-open"></i> Saved Knowledge Snippets</h2>
            </div>
            <div class="card-body">
                <div th:if="${savedSnippets != null and not #lists.isEmpty(savedSnippets)}">
                    <div class="list-group">
                        <div th:each="snippet : ${savedSnippets}" class="list-group-item list-group-item-action flex-column align-items-start mb-2">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1" th:text="'Query: ' + ${snippet.userQuery}">Query</h5>
                                <small th:text="'Saved: ' + ${#temporals.format(snippet.createdAt, 'yyyy-MM-dd HH:mm')}">Date</small>
                            </div>
                            <p class="mb-1"><strong>Source PDF:</strong> <span th:text="${snippet.originalPdfFilename}">Filename</span></p>
                            <div class="snippet-text mb-2" th:text="${snippet.extractedSnippet}">Snippet text</div>
                            <form th:action="@{'/extract/snippets/delete/' + ${snippet.id}}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this snippet?');">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div th:if="${savedSnippets == null or #lists.isEmpty(savedSnippets)}">
                    <p class="text-muted">No knowledge snippets saved yet.</p>
                </div>
            </div>
        </div>


        <div class="footer-links mt-4 text-center">
            <a href="/" class="btn btn-outline-secondary">Back to Home</a>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: page-footer}"></div>

    <!-- Processing Modal -->
    <div class="modal fade" id="extractionProcessingModal" tabindex="-1" aria-labelledby="extractionProcessingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="extractionProcessingModalLabel">Extracting Knowledge...</h5>
                    <!-- Add a close button if cancellation is implemented on backend
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="cancelExtractionButton"></button>
                    -->
                </div>
                <div class="modal-body">
                    <p id="extractionProgressMessage">Initializing process for <strong id="processingPdfFilename">your file</strong>...</p>
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="extractionProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                            0%
                        </div>
                    </div>
                    <p><small>Current Stage: <span id="extractionCurrentStage">Starting...</span></small></p>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-sm btn-warning" id="stopExtractionButton" disabled>Stop Process (Not Implemented)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome for icons (optional) -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        
        let extractionPollInterval;
        const extractionProcessingModal = new bootstrap.Modal(document.getElementById('extractionProcessingModal'));
        const extractionProgressBar = document.getElementById('extractionProgressBar');
        const extractionProgressMessage = document.getElementById('extractionProgressMessage');
        const extractionCurrentStage = document.getElementById('extractionCurrentStage');
        const processingPdfFilenameSpan = document.getElementById('processingPdfFilename');

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('taskId');
            const completedTaskId = urlParams.get('completedTaskId'); // From controller redirect

            if (taskId) {
                // Attempt to get original filename from form if possible, or use a generic message
                // This part is tricky as the form data isn't directly available after redirect.
                // The controller could pass originalFilename via RedirectAttributes if needed.
                // For now, let's use a placeholder or what might be available.
                const submittedPdfName = localStorage.getItem('processingPdfFilename'); // Try to get from local storage
                if (submittedPdfName) {
                    processingPdfFilenameSpan.textContent = submittedPdfName;
                    localStorage.removeItem('processingPdfFilename'); // Clean up
                } else {
                    processingPdfFilenameSpan.textContent = 'your file';
                }
                
                extractionProgressMessage.textContent = 'Processing PDF: ' + processingPdfFilenameSpan.textContent;
                extractionProgressBar.style.width = '5%';
                extractionProgressBar.textContent = '5%';
                extractionProgressBar.setAttribute('aria-valuenow', '5');
                extractionCurrentStage.textContent = 'Initializing...';
                extractionProcessingModal.show();
                pollExtractionProgress(taskId);
            } else if (completedTaskId) {
                // If modal was open for this task and it completed, it would have been handled by polling.
                // This is more for if the user navigates away and comes back with completedTaskId.
                // We might show a success/failure message based on task status if we fetched it here.
                console.log("Task " + completedTaskId + " processing finished.");
            }

            const extractionForm = document.querySelector('form[action="/extract/process"]');
            if (extractionForm) {
                extractionForm.addEventListener('submit', function() {
                    const pdfFileField = document.getElementById('pdfFile');
                    if (pdfFileField && pdfFileField.files.length > 0) {
                        localStorage.setItem('processingPdfFilename', pdfFileField.files[0].name);
                    }
                    // Modal will be shown by redirect with taskId
                });
            }
        });

        function pollExtractionProgress(taskId) {
            extractionPollInterval = setInterval(function() {
                fetch(`/extract/progress/${taskId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data) { // Task ID might not be found immediately or if error
                            extractionProgressMessage.textContent = 'Waiting for task to start or task not found...';
                            return;
                        }

                        extractionProgressBar.style.width = data.progressPercent + '%';
                        extractionProgressBar.textContent = data.progressPercent + '%';
                        extractionProgressBar.setAttribute('aria-valuenow', data.progressPercent);
                        extractionProgressMessage.textContent = data.message || 'Processing...';
                        extractionCurrentStage.textContent = data.currentStage || 'Working...';

                        if (data.completed) {
                            clearInterval(extractionPollInterval);
                            extractionProgressMessage.textContent = data.success ? ('Completed: ' + data.message) : ('Failed: ' + data.message);
                            if(data.success) {
                                extractionProgressBar.classList.remove('progress-bar-animated');
                                extractionProgressBar.classList.remove('bg-primary'); // if it was set
                                extractionProgressBar.classList.add('bg-success');
                            } else {
                                extractionProgressBar.classList.remove('progress-bar-animated');
                                extractionProgressBar.classList.add('bg-danger');
                            }
                            // Redirect to refresh the page and show results/messages from controller
                            // Or update parts of the page dynamically.
                            // For now, a delay then reload to pick up flash attributes.
                            setTimeout(() => {
                                extractionProcessingModal.hide();
                                window.location.href = '/extract?completedTaskId=' + taskId; // Notify controller
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling progress:', error);
                        extractionProgressMessage.textContent = 'Error polling progress: ' + error.message;
                        extractionProgressBar.classList.add('bg-danger');
                        clearInterval(extractionPollInterval);
                         setTimeout(() => {
                            extractionProcessingModal.hide();
                        }, 3000);
                    });
            }, 2000); // Poll every 2 seconds
        }

        // Placeholder for stop functionality
        // document.getElementById('stopExtractionButton').addEventListener('click', function() {
        //     const taskId = new URLSearchParams(window.location.search).get('taskId');
        //     if (taskId && extractionPollInterval) {
        //         // Send a request to backend to stop task taskId
        //         // fetch(`/extract/cancel/${taskId}`, { method: 'POST' })
        //         // .then(...)
        //         console.log("Stop requested for task: " + taskId + " (backend not implemented)");
        //         clearInterval(extractionPollInterval);
        //         extractionProgressMessage.textContent = 'Stopping process... (Backend cancellation not implemented)';
        //         extractionProcessingModal.hide();
        //     }
        // });

        /*]]>*/
    </script>
</body>
</html>